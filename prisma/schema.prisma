generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEMBER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  PAUSED
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  name               String?
  password           String
  avatarUrl          String?
  emailVerified      Boolean   @default(false)
  emailVerifiedAt    DateTime?
  resetToken         String?
  resetTokenExpiry   DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  memberships        Member[]
  invitesSent        Invite[]  @relation("InviteSender")
  invitesReceived    Invite[]  @relation("InviteRecipient")
  refreshTokens      RefreshToken[]
  notifications      Notification[]

  @@map("users")
}

model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@map("refresh_tokens")
}

model Organization {
  id                 String    @id @default(cuid())
  name               String
  slug               String    @unique
  logoUrl            String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  members            Member[]
  invites            Invite[]
  subscription       Subscription?
  integrations       Integration[]
  apiKeys            ApiKey[]
  submissions        Submission[]
  leads              Lead[]

  @@map("organizations")
}

model Member {
  id             String       @id @default(cuid())
  role           Role         @default(MEMBER)
  userId         String
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("members")
}

model Invite {
  id             String       @id @default(cuid())
  email          String
  role           Role         @default(MEMBER)
  status         InviteStatus @default(PENDING)
  token          String       @unique @default(cuid())
  expiresAt      DateTime
  organizationId String
  senderId       String
  recipientId    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sender         User         @relation("InviteSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient      User?        @relation("InviteRecipient", fields: [recipientId], references: [id], onDelete: SetNull)

  @@map("invites")
}

model Plan {
  id              String    @id @default(cuid())
  name            String    @unique
  slug            String    @unique
  description     String?
  price           Float
  currency        String    @default("BRL")
  interval        String    @default("month") // month, year
  features        String[]
  maxMembers      Int       @default(1)
  maxStorage      Int       @default(100) // in MB
  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)
  stripeProductId String?
  stripePriceId   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                       String             @id @default(cuid())
  status                   SubscriptionStatus @default(ACTIVE)
  organizationId           String             @unique
  planId                   String
  stripeCustomerId         String?
  stripeSubscriptionId     String?
  currentPeriodStart       DateTime
  currentPeriodEnd         DateTime
  cancelAtPeriodEnd        Boolean            @default(false)
  canceledAt               DateTime?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  // Relations
  organization             Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan                     Plan               @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model Upload {
  id          String   @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  bucket      String
  key         String
  uploadedBy  String?
  createdAt   DateTime @default(now())

  @@map("uploads")
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum NotificationType {
  INVITE
  MEMBER_ADDED
  MEMBER_REMOVED
  ROLE_CHANGED
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_CANCELED
  INTEGRATION_CONNECTED
  INTEGRATION_ERROR
  GENERAL
}

model Integration {
  id              String            @id @default(cuid())
  organizationId  String
  provider        String            // chatgpt, zapier, figma, google-drive, calendar, etc
  name            String
  apiKey          String?           // Encrypted API key
  accessToken     String?           // Encrypted access token
  refreshToken    String?           // Encrypted refresh token
  config          Json?             // Additional configuration
  status          IntegrationStatus @default(ACTIVE)
  lastSyncAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@map("integrations")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  type        NotificationType @default(GENERAL)
  title       String
  message     String
  read        Boolean          @default(false)
  actionUrl   String?
  metadata    Json?
  createdAt   DateTime         @default(now())

  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ApiKey {
  id              String    @id @default(cuid())
  name            String
  key             String    @unique
  organizationId  String
  createdBy       String
  lastUsedAt      DateTime?
  expiresAt       DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

enum SubmissionStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
  ARCHIVED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  EMAIL_CAMPAIGN
  COLD_CALL
  EVENT
  PARTNER
  OTHER
}

model Submission {
  id              String           @id @default(cuid())
  organizationId  String
  userId          String?
  formType        String           // contact, lead, support, custom
  data            Json             // Dados do formul치rio
  status          SubmissionStatus @default(PENDING)
  notes           String?
  reviewedBy      String?
  reviewedAt      DateTime?
  source          String?          // web, mobile, api
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("submissions")
}

model Lead {
  id              String      @id @default(cuid())
  organizationId  String
  name            String
  email           String
  phone           String?
  company         String?
  position        String?
  status          LeadStatus  @default(NEW)
  source          LeadSource  @default(WEBSITE)
  value           Float?      // Valor estimado do neg칩cio
  notes           String?
  assignedTo      String?     // ID do usu치rio respons치vel
  lastContactAt   DateTime?
  nextFollowUpAt  DateTime?
  convertedAt     DateTime?   // Quando virou cliente
  tags            String[]    @default([])
  customFields    Json?       // Campos personalizados
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("leads")
}
